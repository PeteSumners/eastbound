name: Daily AI Content Generation

on:
  schedule:
    # Run every day at 8:00 AM UTC
    - cron: '0 8 * * *'

  # Allow manual trigger with options
  workflow_dispatch:
    inputs:
      auto_publish:
        description: 'Auto-publish draft (true) or leave for review (false)'
        required: false
        type: boolean
        default: false

jobs:
  generate-content:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Create research directory
        run: |
          mkdir -p research

      - name: Monitor Russian media sources
        id: monitor
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          BRIEFING="research/${TODAY}-briefing.json"

          echo "Monitoring Russian media..."
          python scripts/monitor_russian_media.py --output "$BRIEFING"

          echo "briefing_file=${BRIEFING}" >> $GITHUB_OUTPUT

      - name: Generate AI draft
        if: steps.monitor.outputs.briefing_file != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Generating draft with Claude AI..."
          python scripts/generate_ai_draft.py \
            --briefing "${{ steps.monitor.outputs.briefing_file }}" \
            --output "content/drafts/"

      - name: Find generated draft
        id: find_draft
        run: |
          LATEST_DRAFT=$(ls -t content/drafts/*.md 2>/dev/null | head -1)

          if [ -f "$LATEST_DRAFT" ]; then
            echo "draft_file=${LATEST_DRAFT}" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            echo "Draft found: $LATEST_DRAFT"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No draft generated"
          fi

      - name: Auto-publish draft (if enabled)
        if: |
          steps.find_draft.outputs.found == 'true' &&
          (github.event.inputs.auto_publish == 'true' || github.event_name == 'schedule')
        run: |
          DRAFT_FILE="${{ steps.find_draft.outputs.draft_file }}"
          FILENAME=$(basename "$DRAFT_FILE")

          echo "Auto-publishing draft: $FILENAME"

          # Update status to published and move to published/
          sed -i 's/status: draft/status: published/' "$DRAFT_FILE"

          mkdir -p content/published
          mv "$DRAFT_FILE" "content/published/$FILENAME"

          echo "Published: content/published/$FILENAME"

      - name: Create review issue (if not auto-published)
        if: |
          steps.find_draft.outputs.found == 'true' &&
          github.event.inputs.auto_publish != 'true' &&
          github.event_name != 'schedule'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRAFT_FILE="${{ steps.find_draft.outputs.draft_file }}"
          FILENAME=$(basename "$DRAFT_FILE")

          # Extract title from frontmatter
          TITLE=$(grep "^title:" "$DRAFT_FILE" | cut -d'"' -f2)

          gh issue create \
            --title "Review AI-generated draft: $TITLE" \
            --body "A new AI-generated draft is ready for review.

**File:** \`$DRAFT_FILE\`

**Title:** $TITLE

**Status:** Draft (requires approval)

**Next steps:**
1. Review the draft for accuracy and tone
2. Edit if needed
3. Move to \`content/scheduled/\` and change status to \`scheduled\`
4. Or delete if not suitable

**Note:** This content was generated by AI and should be reviewed before publishing." \
            --label "ai-generated,needs-review"

      - name: Commit changes
        if: steps.find_draft.outputs.found == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add content/ research/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "${{ github.event.inputs.auto_publish }}" == "true" ] || [ "${{ github.event_name }}" == "schedule" ]; then
              git commit -m "Auto-publish AI-generated content [automated]"
            else
              git commit -m "Create AI-generated draft for review [automated]"
            fi

            git push
          fi

      - name: Post to Twitter (if auto-published)
        if: |
          steps.find_draft.outputs.found == 'true' &&
          (github.event.inputs.auto_publish == 'true' || github.event_name == 'schedule')
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          DRAFT_FILE="${{ steps.find_draft.outputs.draft_file }}"
          FILENAME=$(basename "$DRAFT_FILE")
          PUBLISHED_FILE="content/published/${FILENAME}"

          if [ -f "$PUBLISHED_FILE" ]; then
            echo "Posting to Twitter..."
            python scripts/post_to_twitter.py --file "$PUBLISHED_FILE" || echo "Twitter posting failed, continuing..."
          fi

      - name: Summary
        if: steps.find_draft.outputs.found == 'true'
        run: |
          if [ "${{ github.event.inputs.auto_publish }}" == "true" ] || [ "${{ github.event_name }}" == "schedule" ]; then
            echo "AI-generated content auto-published"
            echo "Check: https://petesumners.github.io/eastbound"
          else
            echo "AI-generated draft created"
            echo "Review required before publishing"
            echo "Check GitHub Issues for review task"
          fi
