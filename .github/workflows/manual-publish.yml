name: Manual Publish

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'Filename to publish (e.g., 2025-11-05-my-post.md)'
        required: true
        type: string
      skip_twitter:
        description: 'Skip Twitter posting'
        required: false
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Publish post
        id: publish
        run: |
          python - <<'EOF'
          import os
          import yaml
          from pathlib import Path

          filename = "${{ github.event.inputs.filename }}"

          # Find the file in drafts or scheduled
          draft_file = Path(f"content/drafts/{filename}")
          scheduled_file = Path(f"content/scheduled/{filename}")

          source_file = None
          if draft_file.exists():
              source_file = draft_file
          elif scheduled_file.exists():
              source_file = scheduled_file
          else:
              print(f"ERROR: File not found: {filename}")
              exit(1)

          # Read and update frontmatter
          with open(source_file, 'r', encoding='utf-8') as f:
              content = f.read()

          if content.startswith('---'):
              parts = content.split('---', 2)
              if len(parts) >= 3:
                  frontmatter = yaml.safe_load(parts[1])

                  # Update status
                  frontmatter['status'] = 'published'
                  if 'scheduled_time' in frontmatter:
                      del frontmatter['scheduled_time']

                  # Reconstruct file
                  new_content = f"---\n{yaml.dump(frontmatter, default_flow_style=False)}---{parts[2]}"

                  # Move to published
                  published_dir = Path("content/published")
                  published_dir.mkdir(exist_ok=True)

                  new_path = published_dir / filename
                  with open(new_path, 'w', encoding='utf-8') as f:
                      f.write(new_content)

                  # Remove from source
                  source_file.unlink()

                  print(f"Published: {new_path}")

                  # Save for Twitter
                  with open('published_file.txt', 'w') as f:
                      f.write(str(new_path))

                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("success=true\n")
          EOF

      - name: Commit changes
        if: steps.publish.outputs.success == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add content/
          git commit -m "Published: ${{ github.event.inputs.filename }} [manual]"
          git push

      - name: Post to Twitter
        if: steps.publish.outputs.success == 'true' && github.event.inputs.skip_twitter != 'true'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          pip install tweepy pyyaml

          if [ -f published_file.txt ]; then
            PUBLISHED_FILE=$(cat published_file.txt)
            echo "Posting to Twitter..."
            python scripts/post_to_twitter.py --file "$PUBLISHED_FILE" || echo "Twitter posting failed, continuing..."
          fi
