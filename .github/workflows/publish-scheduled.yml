name: Publish Scheduled Posts

on:
  schedule:
    # Check every hour for scheduled posts
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  publish-scheduled:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Check for scheduled posts
        id: check
        run: |
          python - <<'EOF'
          import os
          import yaml
          from datetime import datetime, timezone
          from pathlib import Path

          scheduled_dir = Path("content/scheduled")
          if not scheduled_dir.exists():
              print("No scheduled directory found")
              exit(0)

          now = datetime.now(timezone.utc)
          published_any = False

          for md_file in scheduled_dir.glob("*.md"):
              with open(md_file, 'r', encoding='utf-8') as f:
                  content = f.read()

              # Parse frontmatter
              if content.startswith('---'):
                  parts = content.split('---', 2)
                  if len(parts) >= 3:
                      frontmatter = yaml.safe_load(parts[1])

                      # Check if scheduled time has passed
                      scheduled_time = frontmatter.get('scheduled_time')
                      if scheduled_time:
                          scheduled_dt = datetime.fromisoformat(scheduled_time.replace('Z', '+00:00'))

                          if scheduled_dt <= now:
                              print(f"Publishing: {md_file.name}")

                              # Update status to published
                              frontmatter['status'] = 'published'
                              del frontmatter['scheduled_time']

                              # Reconstruct file
                              new_content = f"---\n{yaml.dump(frontmatter, default_flow_style=False)}---{parts[2]}"

                              # Move to published
                              published_dir = Path("content/published")
                              published_dir.mkdir(exist_ok=True)

                              new_path = published_dir / md_file.name
                              with open(new_path, 'w', encoding='utf-8') as f:
                                  f.write(new_content)

                              # Remove from scheduled
                              md_file.unlink()

                              published_any = True

                              # Save filename for Twitter
                              with open('published_file.txt', 'w') as f:
                                  f.write(str(new_path))

          if published_any:
              print("published=true")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("published=true\n")
          else:
              print("published=false")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("published=false\n")
          EOF

      - name: Commit published posts
        if: steps.check.outputs.published == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add content/
          git commit -m "Auto-publish scheduled post(s) [automated]"
          git push

      - name: Post to Twitter
        if: steps.check.outputs.published == 'true'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          pip install tweepy pyyaml

          if [ -f published_file.txt ]; then
            PUBLISHED_FILE=$(cat published_file.txt)
            echo "Posting to Twitter..."
            python scripts/post_to_twitter.py --file "$PUBLISHED_FILE" || echo "Twitter posting failed, continuing..."
          fi
