name: Publish Scheduled Posts

# This workflow runs every hour to check for posts that are ready to publish
on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml markdown tweepy

      - name: Find posts ready to publish
        id: find_posts
        run: |
          echo "Checking for scheduled posts..."

          # Get current date and time
          CURRENT_DATETIME=$(date -u +"%Y-%m-%d %H:%M")
          echo "Current UTC time: $CURRENT_DATETIME"

          # Find all markdown files in scheduled directory
          if [ -d "content/scheduled" ]; then
            POSTS_TO_PUBLISH=""

            for file in content/scheduled/*.md; do
              if [ -f "$file" ]; then
                # Extract date and time from frontmatter
                POST_DATE=$(grep "^date:" "$file" | cut -d'"' -f2 | tr -d ' ')
                POST_TIME=$(grep "^publish_time:" "$file" | cut -d'"' -f2 | tr -d ' ')
                POST_STATUS=$(grep "^status:" "$file" | awk '{print $2}' | tr -d ' ')

                echo "Found: $file (date: $POST_DATE, time: $POST_TIME, status: $POST_STATUS)"

                # Check if post is scheduled and time has passed
                if [ "$POST_STATUS" = "scheduled" ]; then
                  POST_DATETIME="${POST_DATE} ${POST_TIME}"
                  if [[ "$POST_DATETIME" < "$CURRENT_DATETIME" ]]; then
                    echo "  ✅ Ready to publish: $file"
                    POSTS_TO_PUBLISH="${POSTS_TO_PUBLISH} ${file}"
                  else
                    echo "  ⏰ Not yet time: $file"
                  fi
                fi
              fi
            done

            echo "posts=${POSTS_TO_PUBLISH}" >> $GITHUB_OUTPUT
          else
            echo "No scheduled directory found"
            echo "posts=" >> $GITHUB_OUTPUT
          fi

      - name: Publish to Substack
        if: steps.find_posts.outputs.posts != ''
        env:
          SUBSTACK_EMAIL: ${{ secrets.SUBSTACK_EMAIL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          for file in ${{ steps.find_posts.outputs.posts }}; do
            echo "Publishing: $file"
            python scripts/publish_to_substack.py --file "$file"
          done

      - name: Post to Twitter/X
        if: steps.find_posts.outputs.posts != ''
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          # Wait a few minutes for Substack to process the email
          echo "Waiting 3 minutes for Substack to process..."
          sleep 180

          for file in ${{ steps.find_posts.outputs.posts }}; do
            # File has been moved to published/ by publish_to_substack.py
            published_file=$(echo "$file" | sed 's/scheduled/published/')

            if [ -f "$published_file" ]; then
              echo "Posting to Twitter: $published_file"
              python scripts/post_to_twitter.py --file "$published_file"
            else
              echo "Warning: Published file not found: $published_file"
            fi
          done

      - name: Commit changes
        if: steps.find_posts.outputs.posts != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add content/
          git diff --staged --quiet || git commit -m "Published scheduled posts [automated]"
          git push
