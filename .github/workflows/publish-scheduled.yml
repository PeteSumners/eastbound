name: Publish Scheduled Posts

# This workflow runs every hour to check for posts that are ready to publish
on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml tweepy

      - name: Find posts ready to publish
        id: find_posts
        run: |
          echo "Checking for scheduled posts..."

          # Get current date and time
          CURRENT_DATETIME=$(date -u +"%Y-%m-%d %H:%M")
          echo "Current UTC time: $CURRENT_DATETIME"

          # Find all markdown files in scheduled directory
          if [ -d "content/scheduled" ]; then
            POSTS_TO_PUBLISH=""

            for file in content/scheduled/*.md; do
              if [ -f "$file" ]; then
                # Extract date and time from frontmatter
                POST_DATE=$(grep "^date:" "$file" | cut -d'"' -f2 | tr -d ' ')
                POST_TIME=$(grep "^publish_time:" "$file" | cut -d'"' -f2 | tr -d ' ')
                POST_STATUS=$(grep "^status:" "$file" | awk '{print $2}' | tr -d ' ')

                echo "Found: $file (date: $POST_DATE, time: $POST_TIME, status: $POST_STATUS)"

                # Check if post is scheduled and time has passed
                if [ "$POST_STATUS" = "scheduled" ]; then
                  POST_DATETIME="${POST_DATE} ${POST_TIME}"
                  if [[ "$POST_DATETIME" < "$CURRENT_DATETIME" ]]; then
                    echo "  ✅ Ready to publish: $file"
                    POSTS_TO_PUBLISH="${POSTS_TO_PUBLISH} ${file}"
                  else
                    echo "  ⏰ Not yet time: $file"
                  fi
                fi
              fi
            done

            echo "posts=${POSTS_TO_PUBLISH}" >> $GITHUB_OUTPUT
          else
            echo "No scheduled directory found"
            echo "posts=" >> $GITHUB_OUTPUT
          fi

      - name: Move to published
        if: steps.find_posts.outputs.posts != ''
        run: |
          for file in ${{ steps.find_posts.outputs.posts }}; do
            FILENAME=$(basename "$file")
            echo "Publishing: $file"

            # Update status to published
            sed -i 's/status: scheduled/status: published/' "$file"

            # Move to published directory
            mkdir -p content/published
            mv "$file" "content/published/$FILENAME"

            echo "✅ Published: content/published/$FILENAME"
          done

      - name: Post to Twitter/X
        if: steps.find_posts.outputs.posts != ''
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          for file in ${{ steps.find_posts.outputs.posts }}; do
            FILENAME=$(basename "$file")
            PUBLISHED_FILE="content/published/${FILENAME}"

            if [ -f "$PUBLISHED_FILE" ]; then
              echo "Posting to Twitter: $PUBLISHED_FILE"
              python scripts/post_to_twitter.py --file "$PUBLISHED_FILE" || echo "Twitter posting failed, continuing..."
            fi
          done

      - name: Trigger GitHub Pages rebuild
        if: steps.find_posts.outputs.posts != ''
        run: |
          # Create an empty commit to trigger Pages rebuild
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Pages will rebuild automatically when we push

      - name: Commit changes
        if: steps.find_posts.outputs.posts != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add content/
          git diff --staged --quiet || git commit -m "Published scheduled posts [automated]"
          git push
